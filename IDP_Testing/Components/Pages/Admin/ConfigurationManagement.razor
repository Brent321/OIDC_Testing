@page "/admin/configuration"
@using IDP_Testing.Services
@using IDP_Testing.Models
@attribute [Authorize(Roles = "app-admin")]
@rendermode InteractiveServer
@inject IConfigurationService ConfigService
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime

<PageTitle>Configuration Management</PageTitle>

<div class="container mt-4">
    <h3><i class="bi bi-gear-fill"></i> Configuration Management</h3>
    <p class="text-muted">View active configuration and manage database overrides</p>

    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "active" ? "active" : "")" 
                    @onclick="ShowActiveTab" 
                    type="button">
                <i class="bi bi-eye"></i> Active Configuration
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "database" ? "active" : "")" 
                    @onclick="ShowDatabaseTab" 
                    type="button">
                <i class="bi bi-database"></i> Database Overrides
            </button>
        </li>
    </ul>

    @if (activeTab == "active")
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            This shows the <strong>currently active configuration</strong> loaded in the application. 
            Database values override appsettings.json values.
        </div>

        <div class="mb-3">
            <input type="text" 
                   class="form-control" 
                   placeholder="Search configuration keys..." 
                   @bind="searchFilter"
                   @bind:event="oninput" />
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Active Value</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var config in GetFilteredActiveConfigurations())
                    {
                        <tr>
                            <td>
                                <code>@config.Key</code>
                                @if (config.IsInDatabase)
                                {
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="bi bi-database"></i> DB Override
                                    </span>
                                }
                            </td>
                            <td>
                                @if (IsSensitiveKey(config.Key))
                                {
                                    <span class="text-muted">
                                        <i class="bi bi-lock-fill"></i> ••••••••
                                    </span>
                                }
                                else
                                {
                                    @config.Value
                                }
                            </td>
                            <td>
                                @if (config.IsInDatabase)
                                {
                                    <span class="badge bg-primary">Database</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">AppSettings</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            
            <p class="text-muted mt-2">
                <i class="bi bi-info-circle"></i> Showing @GetFilteredActiveConfigurations().Count of @activeConfigurations.Count configuration values
            </p>
        </div>

        @if (!GetFilteredActiveConfigurations().Any())
        {
            <div class="alert alert-warning">
                No configuration values match your search.
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> 
            Manage database configuration overrides. These values take precedence over appsettings.json.
        </div>

        <div class="mb-3">
            <button class="btn btn-success" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle"></i> Add Override
            </button>
            <button class="btn btn-warning" @onclick="ReloadConfiguration">
                <i class="bi bi-arrow-clockwise"></i> Reload Configuration
            </button>
            <button class="btn btn-danger" @onclick="ResetToAppSettings">
                <i class="bi bi-arrow-counterclockwise"></i> Reset All Overrides
            </button>
        </div>

        @if (configurations == null)
        {
            <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (!configurations.Any())
        {
            <div class="alert alert-info">
                No database overrides configured. All values are loaded from appsettings.json.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Override Value</th>
                            <th>Last Modified</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var config in configurations)
                        {
                            <tr>
                                <td><code>@config.Key</code></td>
                                <td>
                                    @if (IsSensitiveKey(config.Key))
                                    {
                                        <span class="text-muted">
                                            <i class="bi bi-lock-fill"></i> ••••••••
                                        </span>
                                    }
                                    else
                                    {
                                        @config.Value
                                    }
                                </td>
                                <td>@config.LastModified.ToLocalTime().ToString("g")</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" @onclick="() => ShowEditModal(config)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteConfiguration(config)">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }

    @if (showModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isEdit ? "Edit" : "Add") Configuration Override</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Key</label>
                            <input type="text" class="form-control" @bind="currentKey" disabled="@isEdit" />
                            @if (!isEdit)
                            {
                                <div class="form-text">
                                    Use colon (:) for nested keys. Examples:
                                    <br/>• Keycloak:Authority
                                    <br/>• AuthenticationMode
                                    <br/>• Saml2:EntityId
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Value</label>
                            <input type="text" class="form-control" @bind="currentValue" />
                            <div class="form-text">This will override the value in appsettings.json</div>
                        </div>
                        @if (!isEdit && !string.IsNullOrEmpty(currentKey))
                        {
                            <div class="mb-3">
                                <label class="form-label">Current Active Value</label>
                                <input type="text" class="form-control" value="@Configuration[currentKey]" disabled />
                                <div class="form-text">This is the current value from appsettings.json</div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveConfiguration">Save Override</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ConfigurationEntry>? configurations;
    private List<ActiveConfigurationItem> activeConfigurations = new();
    private bool showModal = false;
    private bool isEdit = false;
    private string currentKey = string.Empty;
    private string? currentValue;
    private string activeTab = "active";
    private string searchFilter = string.Empty;

    private class ActiveConfigurationItem
    {
        public string Key { get; set; } = string.Empty;
        public string? Value { get; set; }
        public bool IsInDatabase { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigurations();
        LoadActiveConfiguration();
    }

    private void ShowActiveTab()
    {
        activeTab = "active";
    }

    private void ShowDatabaseTab()
    {
        activeTab = "database";
    }

    private void LoadActiveConfiguration()
    {
        var dbKeys = configurations?.Select(c => c.Key).ToHashSet() ?? new HashSet<string>();
        activeConfigurations = new List<ActiveConfigurationItem>();

        // Get ALL configuration values by enumerating the configuration root
        if (Configuration is IConfigurationRoot configRoot)
        {
            var allKeys = new HashSet<string>();
            
            // Recursively get all configuration keys
            void GetAllKeys(IConfiguration config, string prefix = "")
            {
                foreach (var child in config.GetChildren())
                {
                    var key = string.IsNullOrEmpty(prefix) ? child.Key : $"{prefix}:{child.Key}";
                    
                    // If this child has children, recurse
                    if (child.GetChildren().Any())
                    {
                        GetAllKeys(child, key);
                    }
                    else
                    {
                        // Leaf node - add to our list
                        allKeys.Add(key);
                    }
                }
            }

            GetAllKeys(Configuration);

            // Create configuration items for all keys
            foreach (var key in allKeys.OrderBy(k => k))
            {
                var value = Configuration[key];
                if (!string.IsNullOrEmpty(value))
                {
                    activeConfigurations.Add(new ActiveConfigurationItem
                    {
                        Key = key,
                        Value = value,
                        IsInDatabase = dbKeys.Contains(key)
                    });
                }
            }
        }
    }

    private List<ActiveConfigurationItem> GetFilteredActiveConfigurations()
    {
        if (string.IsNullOrWhiteSpace(searchFilter))
            return activeConfigurations;

        return activeConfigurations
            .Where(c => c.Key.Contains(searchFilter, StringComparison.OrdinalIgnoreCase) ||
                       (c.Value?.Contains(searchFilter, StringComparison.OrdinalIgnoreCase) ?? false))
            .ToList();
    }

    private bool IsSensitiveKey(string key)
    {
        var sensitiveKeywords = new[] { "secret", "password", "connectionstring", "key", "token" };
        return sensitiveKeywords.Any(keyword => key.Contains(keyword, StringComparison.OrdinalIgnoreCase));
    }

    private async Task LoadConfigurations()
    {
        configurations = await ConfigService.GetAllAsync();
        LoadActiveConfiguration();
    }

    private void ShowAddModal()
    {
        isEdit = false;
        currentKey = string.Empty;
        currentValue = null;
        showModal = true;
    }

    private void ShowEditModal(ConfigurationEntry config)
    {
        isEdit = true;
        currentKey = config.Key;
        currentValue = config.Value;
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task SaveConfiguration()
    {
        if (string.IsNullOrWhiteSpace(currentKey))
            return;

        await ConfigService.AddOrUpdateAsync(currentKey, currentValue);
        await LoadConfigurations();
        CloseModal();
    }

    private async Task DeleteConfiguration(ConfigurationEntry config)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Delete configuration override for '{config.Key}'? The value will revert to appsettings.json.");
        if (confirmed)
        {
            await ConfigService.DeleteAsync(config.Key);
            await LoadConfigurations();
        }
    }

    private async Task ReloadConfiguration()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Reload configuration from database? This will apply any changes without restarting the application.");
        if (confirmed)
        {
            await ConfigService.ReloadConfigurationAsync();
            await LoadConfigurations();
        }
    }

    private async Task ResetToAppSettings()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            "This will delete ALL database configuration overrides and reload from appsettings.json. Continue?");
        if (confirmed)
        {
            await ConfigService.ResetFromAppSettingsAsync();
            await LoadConfigurations();
        }
    }
}